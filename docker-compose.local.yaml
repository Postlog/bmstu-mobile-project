version: "3.8"
services:
  service-image-storage:
    container_name: service-image-storage
    build: 
      context: ./service-image-storage
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8080
      - IMAGES_FOLDER_PATH=./images
      - APP_ENV=local
    ports:
      - "8081:8080"
    volumes:
      - image-storage-volume:/images
    networks:
      - global
    restart: unless-stopped
    healthcheck:
      test: curl http://127.0.0.1:8080/info
      interval: 5s
      retries: 2
      start_period: 10s
      timeout: 2s

  service-api-composition:
    container_name: service-api-composition
    depends_on:
      api-composition-postgres:
        condition: service_healthy
    build: 
      context: ./service-api-composition
      dockerfile: Dockerfile
    ports:
      - "80:8080"
    environment:
      - SERVER_PORT=8080
      - SERVICE_IMAGE_STORAGE_URL=http://service-image-storage:8080
      - SERVICE_IMAGE_STORAGE_TIMEOUT=1s
      - APP_ENV=local
    networks:
      - global
    restart: unless-stopped
    healthcheck:
      test: curl http://127.0.0.1:8080/info
      interval: 5s
      retries: 2
      start_period: 10s
      timeout: 2s

  api-composition-postgres:
    container_name: api-composition-postgres
    image: postgres:16
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=api-composition
    volumes:
      - api-composition-postgres-volume:/var/lib/postgresql
    ports:
      - "2345:5432"
    networks:
      - global
    restart: unless-stopped
    healthcheck:
      test: pg_isready -U postgres
      interval: 5s
      retries: 4
      start_period: 20s
      timeout: 5s

networks:
  global: 

volumes:
  image-storage-volume:
  api-composition-postgres-volume:
